#!/usr/bin/python3

import os,requests

def get_city():
    try:
        r = requests.get(f'https://ipinfo.io', timeout=5)
        r.raise_for_status()
    except:
        return ""

    return r.json()["city"]

def openweathermap(location):
    msg = "<span color='red'>{}</span>"

    if location == "":
        print(msg.format("location"))
        exit(1)

    a = os.getenv("OWM_AID")
    if a is None:
        print(msg.format("app_id"))
        exit(2)

    try:
        r = requests.get(f'https://api.openweathermap.org/data/2.5/weather?q={location}&units=metric&lang=zh_cn&appid={a}', timeout=5)
        r.raise_for_status()
    except requests.exceptions.Timeout:
        print(msg.format("timeout"))
        exit(3)
    except Exception as e:
        print(msg.format(type(e).__name__))
        exit(4)

    d = r.json()
    description = d['weather'][0]['description']
    temperature = d['main']['temp']
    print(f"{description} {temperature:.0f}℃")

if __name__ == '__main__':
    location = get_city()

    try:
        r = requests.get(f"https://wttr.in/{location}?format=%l+%c+%t&lang=zh", timeout=5)
    except:
        openweathermap(location)
    else:
        if r and "°C" in r.text:
            print(r.text.rstrip().replace("+", ""))
        else:
            openweathermap(location)
