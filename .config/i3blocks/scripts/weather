#!/usr/bin/python3

import os,requests


error = "<span color='red'>{}</span>"


def get_city():
    c = os.getenv("LOCATION_CITY")
    if c is None:
        try:
            r = requests.get(f'https://ipinfo.io', timeout=10)
            r.raise_for_status()
            return r.json()["city"]
        except:
            print(error.format("location"))
            exit(1)
    else:
        return c


def openweathermap(location):
    a = os.getenv("OWM_AID")
    if a is None:
        print(error.format("app_id"))
        exit(2)

    try:
        r = requests.get(f'https://api.openweathermap.org/data/2.5/weather?q={location}&units=metric&lang=zh_cn&appid={a}', timeout=5)
        r.raise_for_status()
        d = r.json()
        print(f"{d['name']} {d['weather'][0]['description']} {d['main']['temp']:.0f}℃")
        details = [
                    f"Feels Like: {d['main']['feels_like']:.0f}℃",
                    f"Pressure: {d['main']['pressure']} hPa",
                    f"Humidity: {d['main']['humidity']}%",
                    f"Visibility: {d['visibility']} m",
                    f"Cloudiness: {d['clouds']['all']}%",
                    f"Wind Speed: {d['wind']['speed']} m/s",
                    f"Wind Direction: {d['wind']['deg']} degree",
                ]
        if "gust" in d["wind"]:
            details.append(f"Wind Gust: {d['wind']['gust']} m/s")
        print("\r".join(details))
    except Exception as e:
        print(error.format(type(e).__name__))
        exit(3)


if __name__ == '__main__':
    location = get_city()
    openweathermap(location)

